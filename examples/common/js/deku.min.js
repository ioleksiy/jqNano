/* deku.js 0.0.6
 * Templating library focused on pipeline processing.
 * For all details and documentation:
 * http://nakamura-to.github.com/deku/
 */// ./lib/internal/prelude.js
(function(a){if(typeof module=="undefined"||!module.exports)a.deku={internal:{}}})(this),function(a){var b=function(){var a={parse:function(a,c){function j(a,b,c){var d=a,e=c-a.length;for(var f=0;f<e;f++)d=b+d;return d}function k(a){var b=a.charCodeAt(0);if(b<=255)var c="x",d=2;else var c="u",d=4;return"\\"+c+j(b.toString(16).toUpperCase(),"0",d)}function l(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/[\x80-\uFFFF]/g,k)+'"'}function m(a){if(e<g)return;e>g&&(g=e,h=[]),h.push(a)}function n(){var b="Program@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e,h=o();if(h!==null){var j=[],k=o();while(k!==null){j.push(k);var k=o()}if(j!==null)var l=[h,j];else{var l=null;e=g}}else{var l=null;e=g}var n=l!==null?function(a,b){var c=[a],d,e=b.length;for(d=0;d<e;d++)c.push(b[d]);return{type:"type_program",statements:c}}(l[0],l[1]):null;if(n!==null)var p=n;else{var p=null;e=d}if(p!==null)var q=p;else{var r=e;if(a.substr(e,0)===""){var s="";e+=0}else{var s=null;f&&m('""')}var t=s!==null?function(){return{type:"type_program",statements:[]}}():null;if(t!==null)var u=t;else{var u=null;e=r}if(u!==null)var q=u;else var q=null}return i[b]={nextPos:e,result:q},q}function o(){var a="Statement@"+e,b=i[a];if(b)return e=b.nextPos,b.result;var c=p();if(c!==null)var d=c;else{var f=q();if(f!==null)var d=f;else{var g=r();if(g!==null)var d=g;else{var h=s();if(h!==null)var d=h;else{var j=u();if(j!==null)var d=j;else{var k=v();if(k!==null)var d=k;else var d=null}}}}}return i[a]={nextPos:e,result:d},d}function p(){var b="Block@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e;if(a.substr(e,3)==="{{#"){var h="{{#";e+=3}else{var h=null;f&&m('"{{#"')}if(h!==null){var j=C();if(j!==null){var k=x();if(k!==null){var l=t();if(l!==null){var o=C();if(o!==null){if(a.substr(e,2)==="}}"){var p="}}";e+=2}else{var p=null;f&&m('"}}"')}if(p!==null){var q=n();if(q!==null){if(a.substr(e,3)==="{{/"){var r="{{/";e+=3}else{var r=null;f&&m('"{{/"')}if(r!==null){var s=C();if(s!==null){var u=x();if(u!==null){var v=C();if(v!==null){if(a.substr(e,2)==="}}"){var w="}}";e+=2}else{var w=null;f&&m('"}}"')}if(w!==null)var y=[h,j,k,l,o,p,q,r,s,u,v,w];else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}var z=y!==null?function(a,b,c,d){return H(a,d),{type:"type_block",name:a,processors:b,program:c}}(y[2],y[3],y[6],y[9]):null;if(z!==null)var A=z;else{var A=null;e=d}return i[b]={nextPos:e,result:A},A}function q(){var b="Inverse@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e;if(a.substr(e,3)==="{{^"){var h="{{^";e+=3}else{var h=null;f&&m('"{{^"')}if(h!==null){var j=C();if(j!==null){var k=x();if(k!==null){var l=t();if(l!==null){var o=C();if(o!==null){if(a.substr(e,2)==="}}"){var p="}}";e+=2}else{var p=null;f&&m('"}}"')}if(p!==null){var q=n();if(q!==null){if(a.substr(e,3)==="{{/"){var r="{{/";e+=3}else{var r=null;f&&m('"{{/"')}if(r!==null){var s=C();if(s!==null){var u=x();if(u!==null){var v=C();if(v!==null){if(a.substr(e,2)==="}}"){var w="}}";e+=2}else{var w=null;f&&m('"}}"')}if(w!==null)var y=[h,j,k,l,o,p,q,r,s,u,v,w];else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}}else{var y=null;e=g}var z=y!==null?function(a,b,c,d){return H(a,d),{type:"type_inverse",name:a,processors:b,program:c}}(y[2],y[3],y[6],y[9]):null;if(z!==null)var A=z;else{var A=null;e=d}return i[b]={nextPos:e,result:A},A}function r(){var b="Partial@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e;if(a.substr(e,3)==="{{:"){var h="{{:";e+=3}else{var h=null;f&&m('"{{:"')}if(h!==null){var j=C();if(j!==null){var k=x();if(k!==null){var l=e,n=D();if(n!==null){var o=[];while(n!==null){o.push(n);var n=D()}}else var o=null;if(o!==null){var p=x();if(p!==null)var q=[o,p];else{var q=null;e=l}}else{var q=null;e=l}var r=q!==null?q:"";if(r!==null){var s=C();if(s!==null){if(a.substr(e,2)==="}}"){var t="}}";e+=2}else{var t=null;f&&m('"}}"')}if(t!==null)var u=[h,j,k,r,s,t];else{var u=null;e=g}}else{var u=null;e=g}}else{var u=null;e=g}}else{var u=null;e=g}}else{var u=null;e=g}}else{var u=null;e=g}var v=u!==null?function(a,b){return{type:"type_partial",name:a,context:b[1]||G}}(u[2],u[3]):null;if(v!==null)var w=v;else{var w=null;e=d}return i[b]={nextPos:e,result:w},w}function s(){var b="Mustache@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e;if(a.substr(e,2)==="{{"){var h="{{";e+=2}else{var h=null;f&&m('"{{"')}if(h!==null){var j=C();if(j!==null){var k=x();if(k!==null){var l=t();if(l!==null){var n=C();if(n!==null){if(a.substr(e,2)==="}}"){var o="}}";e+=2}else{var o=null;f&&m('"}}"')}if(o!==null)var p=[h,j,k,l,n,o];else{var p=null;e=g}}else{var p=null;e=g}}else{var p=null;e=g}}else{var p=null;e=g}}else{var p=null;e=g}}else{var p=null;e=g}var q=p!==null?function(a,b){return{type:"type_mustache",name:a,processors:b,escape:!0}}(p[2],p[3]):null;if(q!==null)var r=q;else{var r=null;e=d}if(r!==null)var s=r;else{var u=e,v=e;if(a.substr(e,3)==="{{{"){var w="{{{";e+=3}else{var w=null;f&&m('"{{{"')}if(w!==null){var y=C();if(y!==null){var z=x();if(z!==null){var A=t();if(A!==null){var B=C();if(B!==null){if(a.substr(e,3)==="}}}"){var D="}}}";e+=3}else{var D=null;f&&m('"}}}"')}if(D!==null)var E=[w,y,z,A,B,D];else{var E=null;e=v}}else{var E=null;e=v}}else{var E=null;e=v}}else{var E=null;e=v}}else{var E=null;e=v}}else{var E=null;e=v}var F=E!==null?function(a,b){return{type:"type_mustache",name:a,processors:b,escape:!1}}(E[2],E[3]):null;if(F!==null)var G=F;else{var G=null;e=u}if(G!==null)var s=G;else var s=null}return i[b]={nextPos:e,result:s},s}function t(){var b="Pipeline@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=[],h=e,j=C();if(j!==null){if(a.substr(e,1)==="|"){var k="|";e+=1}else{var k=null;f&&m('"|"')}if(k!==null){var l=C();if(l!==null){var n=x();if(n!==null)var o=[j,k,l,n];else{var o=null;e=h}}else{var o=null;e=h}}else{var o=null;e=h}}else{var o=null;e=h}while(o!==null){g.push(o);var h=e,j=C();if(j!==null){if(a.substr(e,1)==="|"){var k="|";e+=1}else{var k=null;f&&m('"|"')}if(k!==null){var l=C();if(l!==null){var n=x();if(n!==null)var o=[j,k,l,n];else{var o=null;e=h}}else{var o=null;e=h}}else{var o=null;e=h}}else{var o=null;e=h}}var p=g!==null?function(a){var b=[],c,d=a.length;for(c=0;c<d;c++)b.push(a[c][3]);return b}(g):null;if(p!==null)var q=p;else{var q=null;e=d}if(q!==null)var r=q;else{var s=e,t=e,u=[],v=u!==null?function(){return[]}():null;if(v!==null)var w=v;else{var w=null;e=s}if(w!==null)var r=w;else var r=null}return i[b]={nextPos:e,result:r},r}function u(){var b="Comment@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e;if(a.substr(e,3)==="{{!"){var h="{{!";e+=3}else{var h=null;f&&m('"{{!"')}if(h!==null){var j=[],k=e,l=e,n=f;f=!1;if(a.substr(e,2)==="}}"){var o="}}";e+=2}else{var o=null;f&&m('"}}"')}f=n;if(o===null)var p="";else{var p=null;e=l}if(p!==null){if(a.length>e){var q=a.charAt(e);e++}else{var q=null;f&&m("any character")}if(q!==null)var r=[p,q];else{var r=null;e=k}}else{var r=null;e=k}while(r!==null){j.push(r);var k=e,l=e,n=f;f=!1;if(a.substr(e,2)==="}}"){var o="}}";e+=2}else{var o=null;f&&m('"}}"')}f=n;if(o===null)var p="";else{var p=null;e=l}if(p!==null){if(a.length>e){var q=a.charAt(e);e++}else{var q=null;f&&m("any character")}if(q!==null)var r=[p,q];else{var r=null;e=k}}else{var r=null;e=k}}if(j!==null){if(a.substr(e,2)==="}}"){var s="}}";e+=2}else{var s=null;f&&m('"}}"')}if(s!==null)var t=[h,j,s];else{var t=null;e=g}}else{var t=null;e=g}}else{var t=null;e=g}var u=t!==null?function(a){var b="",c,d=a.length;for(c=0;c<d;c++)b+=a[c][1];return{type:"type_comment",comment:b}}(t[1]):null;if(u!==null)var v=u;else{var v=null;e=d}return i[b]={nextPos:e,result:v},v}function v(){var a="Content@"+e,b=i[a];if(b)return e=b.nextPos,b.result;var c=e,d=w();if(d!==null){var f=[];while(d!==null){f.push(d);var d=w()}}else var f=null;var g=f!==null?function(a){var b="",c,d=a.length;for(c=0;c<d;c++)b+=a[c];return{type:"type_content",content:b}}(f):null;if(g!==null)var h=g;else{var h=null;e=c}return i[a]={nextPos:e,result:h},h}function w(){var b="ContentChars@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e;if(a.substr(e,1)==="\\"){var h="\\";e+=1}else{var h=null;f&&m('"\\\\"')}if(h!==null){if(a.substr(e,1)==="\\"){var j="\\";e+=1}else{var j=null;f&&m('"\\\\"')}if(j!==null){var k=e,l=f;f=!1;if(a.substr(e,2)==="{{"){var n="{{";e+=2}else{var n=null;f&&m('"{{"')}f=l;if(n!==null){var o="";e=k}else var o=null;if(o!==null)var p=[h,j,o];else{var p=null;e=g}}else{var p=null;e=g}}else{var p=null;e=g}var q=p!==null?function(a){return a}(p[1]):null;if(q!==null)var r=q;else{var r=null;e=d}if(r!==null)var s=r;else{var t=e,u=e;if(a.substr(e,1)==="\\"){var v="\\";e+=1}else{var v=null;f&&m('"\\\\"')}if(v!==null){if(a.substr(e,2)==="{{"){var w="{{";e+=2}else{var w=null;f&&m('"{{"')}if(w!==null)var x=[v,w];else{var x=null;e=u}}else{var x=null;e=u}var y=x!==null?function(a){return a}(x[1]):null;if(y!==null)var z=y;else{var z=null;e=t}if(z!==null)var s=z;else{var A=e,B=e,C=e,D=f;f=!1;if(a.substr(e,2)==="{{"){var E="{{";e+=2}else{var E=null;f&&m('"{{"')}f=D;if(E===null)var F="";else{var F=null;e=C}if(F!==null){if(a.length>e){var G=a.charAt(e);e++}else{var G=null;f&&m("any character")}if(G!==null)var H=[F,G];else{var H=null;e=B}}else{var H=null;e=B}var I=H!==null?function(a){return a}(H[1]):null;if(I!==null)var J=I;else{var J=null;e=A}if(J!==null)var s=J;else var s=null}}return i[b]={nextPos:e,result:s},s}function x(){var b="Path@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e,g=e,h=y();if(h!==null)var j=h;else{var k=z();if(k!==null)var j=k;else var j=null}if(j!==null){var l=[],n=e;if(a.substr(e,1)==="."){var o=".";e+=1}else{var o=null;f&&m('"."')}if(o!==null){var p=z();if(p!==null)var q=[o,p];else{var q=null;e=n}}else{var q=null;e=n}while(q!==null){l.push(q);var n=e;if(a.substr(e,1)==="."){var o=".";e+=1}else{var o=null;f&&m('"."')}if(o!==null){var p=z();if(p!==null)var q=[o,p];else{var q=null;e=n}}else{var q=null;e=n}}if(l!==null)var r=[j,l];else{var r=null;e=g}}else{var r=null;e=g}var s=r!==null?function(a,b){var c=[a.id||a],d,e=b.length;for(d=0;d<e;d++)c.push(b[d][1]);return{type:"type_name",path:c.join("."),segments:c,contextType:a.type||"default",contextIndex:a.index||"0"}}(r[0],r[1]):null;if(s!==null)var t=s;else{var t=null;e=d}return i[b]={nextPos:e,result:t},t}function y(){var b="ReservedId@"+e,c=i[b];if(c)return e=c.nextPos,c.result;var d=e;if(a.substr(e,5)==="@root"){var g="@root";e+=5}else{var g=null;f&&m('"@root"')}var h=g!==null?function(){return{type:"root",id:"@root"}}():null;if(h!==null)var j=h;else{var j=null;e=d}if(j!==null)var k=j;else{var l=e;if(a.substr(e,6)==="@index"){var n="@index";e+=6}else{var n=null;f&&m('"@index"')}var o=n!==null?function(){return{type:"index",id:"@index"}}():null;if(o!==null)var p=o;else{var p=null;e=l}if(p!==null)var k=p;else{var q=e;if(a.substr(e,8)==="@hasNext"){var r="@hasNext";e+=8}else{var r=null;f&&m('"@hasNext"')}var s=r!==null?function(){return{type:"hasNext",id:"@hasNext"}}():null;if(s!==null)var t=s;else{var t=null;e=q}if(t!==null)var k=t;else{var u=e;if(a.substr(e,7)==="@length"){var v="@length";e+=7}else{var v=null;f&&m('"@length"')}var w=v!==null?function(){return{type:"length",id:"@length"}}():null;if(w!==null)var x=w;else{var x=null;e=u}if(x!==null)var k=x;else{var y=e,z=e;if(a.substr(e,1)==="@"){var A="@";e+=1}else{var A=null;f&&m('"@"')}if(A!==null){if(a.substr(e).match(/^[0-9]/)!==null){var B=a.charAt(e);e++}else{var B=null;f&&m("[0-9]")}if(B!==null){var C=[];while(B!==null){C.push(B);if(a.substr(e).match(/^[0-9]/)!==null){var B=a.charAt(e);e++}else{var B=null;f&&m("[0-9]")}}}else var C=null;if(C!==null)var D=[A,C];else{var D=null;e=z}}else{var D=null;e=z}var E=D!==null?function(a){return{type:"ref",index:a,id:"@"+a}}(D[1]):null;if(E!==null)var F=E;else{var F=null;e=y}if(F!==null)var k=F;else{var G=e;if(a.substr(e,5)==="@this"){var H="@this";e+=5}else{var H=null;f&&m('"@this"')}var I=H!==null?function(){return{type:"ref",index:0,id:"@this"}}():null;if(I!==null)var J=I;else{var J=null;e=G}if(J!==null)var k=J;else{var K=e;if(a.substr(e,7)==="@parent"){var L="@parent";e+=7}else{var L=null;f&&m('"@parent"')}var M=L!==null?function(){return{type:"ref",index:1,id:"@parent"}}():null;if(M!==null)var N=M;else{var N=null;e=K}if(N!==null)var k=N;else var k=null}}}}}}return i[b]={nextPos:e,result:k},k}function z(){var a="Id@"+e,b=i[a];if(b)return e=b.nextPos,b.result;var c=e,d=e,f=A();if(f!==null){var g=[],h=B();while(h!==null){g.push(h);var h=B()}if(g!==null)var j=[f,g];else{var j=null;e=d}}else{var j=null;e=d}var k=j!==null?function(a,b){var c=a,d,e=b.length;for(d=0;d<e;d++)c+=b[d];return c}(j[0],j[1]):null;if(k!==null)var l=k;else{var l=null;e=c}return i[a]={nextPos:e,result:l},l}function A(){var b="IdStartChar@"+e,c=i[b];if(c)return e=c.nextPos,c.result;if(a.substr(e).match(/^[^\0- {#^!:|\/.]/)!==null){var d=a.charAt(e);e++}else{var d=null;f&&m("[^\\0- {#^!:|\\/.]")}return i[b]={nextPos:e,result:d},d}function B(){var b="IdPartChar@"+e,c=i[b];if(c)return e=c.nextPos,c.result;if(a.substr(e).match(/^[^\0- }|.]/)!==null){var d=a.charAt(e);e++}else{var d=null;f&&m("[^\\0- }|.]")}return i[b]={nextPos:e,result:d},d}function C(){var a="_@"+e,b=i[a];if(b)return e=b.nextPos,b.result;var c=[],d=D();while(d!==null){c.push(d);var d=D()}return i[a]={nextPos:e,result:c},c}function D(){var b="Whitespace@"+e,c=i[b];if(c)return e=c.nextPos,c.result;if(a.substr(e).match(/^[ 	\n\r]/)!==null){var d=a.charAt(e);e++}else{var d=null;f&&m("[ \t\\n\\r]")}return i[b]={nextPos:e,result:d},d}function E(){function b(a){a.sort();var b=null,c=[];for(var d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);switch(c.length){case 0:return"end of input";case 1:return c[0];default:return c.slice(0,c.length-1).join(", ")+" or "+c[c.length-1]}}var c=b(h),d=Math.max(e,g),f=d<a.length?l(a.charAt(d)):"end of input";return"Expected "+c+" but "+f+" found."}function F(){var b=1,c=1,d=!1;for(var e=0;e<g;e++){var f=a.charAt(e);f==="\n"?(d||b++,c=1,d=!1):f==="\r"|f==="\u2028"||f==="\u2029"?(b++,c=1,d=!0):(c++,d=!1)}return{line:b,column:c}}function H(a,c){if(a.path!==c.path){var d=F();throw new b.SyntaxError(a.path+" doesn't match "+c.path,d.line,d.column)}}var d={Block:p,Comment:u,Content:v,ContentChars:w,Id:z,IdPartChar:B,IdStartChar:A,Inverse:q,Mustache:s,Partial:r,Path:x,Pipeline:t,Program:n,ReservedId:y,Statement:o,Whitespace:D,_:C};if(c!==undefined){if(d[c]===undefined)throw new Error("Invalid rule name: "+l(c)+".")}else c="Program";var e=0,f=!0,g=0,h=[],i={},G={type:"type_name",path:"@0",segments:["@0"],contextType:"ref",contextIndex:"0"},I=d[c]();if(I===null||e!==a.length){var J=F();throw new this.SyntaxError(E(),J.line,J.column)}return I},toSource:function(){return this._source}};return a.SyntaxError=function(a,b,c){this.name="SyntaxError",this.message=a,this.line=b,this.column=c},a.SyntaxError.prototype=Error.prototype,a}();a(b)}(function(a){typeof module!="undefined"&&module.exports?module.exports=a:deku.internal.parser=a}),function(a,b){var c=b("parser"),d=function(){var a,b;a=function(a){this.opcodes=[],this.context=a||{all:[]},this.index=this.context.all.length,this.name="program"+this.index,this.context.all.push(this)},a.OPCODE_PARAM_LENGTH_MAP={op_append:0,op_appendContent:1,op_applyProcessor:2,op_applyPrePipeline:1,op_applyPostPipeline:1,op_escape:0,op_evaluateValue:1,op_lookupHead:4,op_lookupTail:2,op_invokePartial:1,op_invokeProgram:1,op_invokeProgramInverse:1},a.prototype={compile:function(a){var b=a.statements,c,d,e=b.length;for(d=0;d<e;d++)c=b[d],this[c.type](c);return this},compileProgram:function(b){var c=new a(this.context);return c.compile(b)},pushOpcode:function(a,b,c,d,e){this.opcodes.push(a),b!==void 0&&this.opcodes.push(b),c!==void 0&&this.opcodes.push(c),d!==void 0&&this.opcodes.push(d),e!==void 0&&this.opcodes.push(e)},type_name:function(a,b){var c=a.segments,d,e=c.length;this.pushOpcode("op_lookupHead",c[0],b,a.contextType,a.contextIndex);for(d=1;d<e;d++)this.pushOpcode("op_lookupTail",c[d],b)},pipeline:function(a){var b=a.processors,c,d=b.length,e=a.name,f=e.path,g;this.type_name(e,"value"),this.pushOpcode("op_evaluateValue",f),this.pushOpcode("op_applyPrePipeline",f);for(c=0;c<d;c++)g=b[c],this.type_name(g,"processor"),this.pushOpcode("op_applyProcessor",g.path,f);this.pushOpcode("op_applyPostPipeline",f)},type_block:function(a){var b=this.compileProgram(a.program);this.pipeline(a),this.pushOpcode("op_invokeProgram",b.name),this.pushOpcode("op_append")},type_inverse:function(a){var b=this.compileProgram(a.program);this.pipeline(a),this.pushOpcode("op_invokeProgramInverse",b.name),this.pushOpcode("op_append")},type_partial:function(a){this.type_name(a.context,"value"),this.pushOpcode("op_invokePartial",a.name.path),this.pushOpcode("op_append")},type_mustache:function(a){this.pipeline(a),a.escape&&this.pushOpcode("op_escape"),this.pushOpcode("op_append")},type_content:function(a){this.pushOpcode("op_appendContent",a.content)},type_comment:function(){}},b=function(a){this.environment=a,this.name=a.name,this.allEnvironments=a.context.all,this.source=[""]},b.prototype={lookup:function(a,b){return a+'["'+b+'"]'},appendToBuffer:function(a){this.source.push("buffer += "+a+";")},quoteString:function(){var a={"\\":"\\\\",'"':'\\"',"\n":"\\n","\r":"\\r"};return function(b){return'"'+b.replace(/[\\"\n\r]/g,function(b){return a[b]})+'"'}}(),compileDescendants:function(){var a=[],c=this.allEnvironments,d,e=c.length,f,g,h;for(d=1;d<e;d++)f=c[d],g=new b(f),h=g.compileSubProgram(),a.push(h);return a},execOpcodes:function(){var b=this.environment.opcodes,c,d=b.length,e,f,g,h;for(c=0;c<d;){e=b[c],h=[],g=a.OPCODE_PARAM_LENGTH_MAP[e];for(c++,f=0;c<d&&f<g;c++,f++)h.push(b[c]);this[e].apply(this,h)}},generate:function(a,b){var c;return this.source[0]=this.source[0]+'var self = this, value, valueContext, buffer = "", contextStack = contextStack || [context], '+"escape = this.escape, handleBlock = this.handleBlock, handleInverse = this.handleInverse, handlePartial = this.handlePartial, "+"noSuchValue = this.noSuchValue, noSuchProcessor = this.noSuchProcessor, prePipeline = this.prePipeline, postPipeline = this.postPipeline, "+"processors = this.processors, processor, processorContext, values = this.values;"+"\n"+a.join("\n"),this.source.push("return buffer;"),c="  "+this.source.join("\n  "),b?"function (context, contextStack, index, hasNext, length) {\n"+c+"\n"+"}":new Function("context","contextStack","index","hasNext","length",c)},compile:function(a){var b=this.compileDescendants();return this.execOpcodes(),this.generate(b,a)},generateSubProgram:function(){var a,b="  ";return this.source[0]=this.source[0]+'var value, valueContext, buffer = "";',this.source.push("return buffer;"),a=b+b+this.source.join("\n  "+b),b+"function "+this.name+" (context, contextStack, index, hasNext, length) {\n"+a+"\n"+b+"}"},compileSubProgram:function(){return this.execOpcodes(),this.generateSubProgram()},op_invokeProgram:function(a){this.source.push("value = handleBlock.call(self, context, contextStack, value, "+a+");")},op_invokeProgramInverse:function(a){this.source.push("value = handleInverse.call(self, context, contextStack, value, "+a+");")},op_invokePartial:function(a){this.source.push('value = handlePartial.call(self, context, contextStack, index, hasNext, length, value, "'+a+'");')},op_applyProcessor:function(a,b){this.source.push('if (typeof processor === "function") { value = processor.call(processorContext, value, "'+b+'", index, hasNext, length); }'),this.source.push("else { processor = "+this.lookup("processors",a)+";"),this.source.push('  if (typeof processor === "function") { value = processor.call(context, value, "'+b+'", index, hasNext, length); }'),this.source.push('  else { value = noSuchProcessor.call(context, "'+a+'", value, "'+b+'"); }}')},op_applyPrePipeline:function(a){this.source.push('value = prePipeline.call(context, value, "'+a+'", index, hasNext, length);')},op_applyPostPipeline:function(a){this.source.push('value = postPipeline.call(context, value, "'+a+'", index, hasNext, length);')},op_escape:function(){this.source.push("value = escape(value);")},op_escapeAndAppendContent:function(a){a=this.quoteString(a),this.appendToBuffer("escape(value) + "+a)},op_append:function(){this.appendToBuffer("value")},op_appendContent:function(a){a=this.quoteString(a),this.appendToBuffer(a)},op_evaluateValue:function(a){this.source.push('if (typeof value === "function") { value = value.call(valueContext); }'),this.source.push("else if (value === void 0) {"),this.source.push('  value = values["'+a+'"];'),this.source.push('  if (value === void 0) { value = noSuchValue.call(context, "'+a+'"); } }')},variableContextMap:{value:"valueContext",processor:"processorContext"},variableMap:{value:"value",processor:"processor"},op_lookupHead:function(a,b,c,d){var e=this.variableContextMap[b],f=this.variableMap[b];this.source.push(e+" = context;");switch(c){case"root":this.source.push(f+" = contextStack[0];");break;case"index":this.source.push(f+" = index;");break;case"hasNext":this.source.push(f+" = hasNext;");break;case"length":this.source.push(f+" = length;");break;case"ref":this.source.push(f+" = contextStack[contextStack.length - 1 - "+d+"];");break;case"default":this.source.push(f+" = "+this.lookup(e,a)+";");break;default:throw new Error("unreachable.")}},op_lookupTail:function(a,b){var c=this.variableContextMap[b],d=this.variableMap[b];this.source.push("if ("+d+" != null) { "+c+" = "+d+"; "+d+" = "+this.lookup(d,a)+";}")}};var d=function(a){try{return c.parse(a)}catch(b){throw b.name==="SyntaxError"?new Error(b.message+" line="+b.line+". column="+b.column+".\n"+a):b}},e=function(c,e){var f=d(c),g=new a,h=g.compile(f),i=new b(h);return i.compile(e)};return{Compiler:a,JsCompiler:b,parse:d,compile:e}}();a(d)}(function(a){typeof module!="undefined"&&module.exports?module.exports=a:deku.internal.compiler=a},function(a){return typeof module!="undefined"&&module.exports?require("./"+a):deku.internal[a]}),function(a,b){var c=b("compiler"),d={isObject:function(a){return a===Object(a)},isArray:Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},extend:function(a){var b=arguments.length,c,d,e;if(a==null)return a;for(c=1;c<b;c++){d=arguments[c];if(d!=null)for(e in d)a[e]===void 0&&(a[e]=d[e])}return a},escape:function(){var a={"&":"&amp;",'"':"&quot;","'":"&#39;","<":"&lt;",">":"&gt;"},b=/[&"'<>]/,c=/[&"'<>]/g;return function(d){if(d==null)return"";switch(typeof d){case"string":break;case"number":return d.toString();default:d=d.toString()}return b.test(d)?d.replace(c,function(b){return a[b]}):d}}(),compile:typeof c!="undefined"?c.compile:function(){throw new Error("The deku.runtime.js doesn't support to compile partial templates. Consider to compile all partial templates with deku compiler in advance.")},handleBlock:function(a,b,c,e){var f="",g,h,i;if(d.isArray(c)){h=c.length;for(g=0;g<h;g++)i=c[g],b.push(i),f+=e(i,b,g,g+1<h,h),b.pop()}else d.isObject(c)?(b.push(c),f=e(c,b),b.pop()):c&&(f=e(a,b));return f},handleInverse:function(a,b,c,e){var f="";return c?d.isArray(c)&&c.length===0&&(f=e(a,b)):f=e(a,b),f},handlePartial:function(a,b,c,e,f,g,h){var i=this,j,k,l;return j=i.partialResolver(h),j==null?i.noSuchPartial(h,g):(typeof j=="function"?k=j:(k=d.compile(j),i.partials[h]=k),b.push(g),l=k.call(i,g,b,c,e,f),b.pop(),l)},prepare:function(a,b){var c={escape:d.escape,handleBlock:d.handleBlock,handleInverse:d.handleInverse,handlePartial:d.handlePartial,noSuchValue:b.noSuchValue,noSuchProcessor:b.noSuchProcessor,noSuchPartial:b.noSuchPartial,prePipeline:b.prePipeline,postPipeline:b.postPipeline,partialResolver:b.partialResolver,values:b.values,partials:b.partials,templates:b.templates,processors:b.processors};return function(b){return a.call(c,b!=null?b:{})}}};a(d)}(function(a){typeof module!="undefined"&&module.exports?module.exports=a:deku.internal.core=a},function(a){return typeof module!="undefined"&&module.exports?require("./"+a):deku.internal[a]}),function(a,b,c){var d=b("core"),e=function(a,b){var e={};b=b||{},e.noSuchValue=b.noSuchValue||c.noSuchValue,e.noSuchPartial=b.noSuchPartial||c.noSuchPartial,e.noSuchProcessor=b.noSuchProcessor||c.noSuchProcessor,e.prePipeline=b.prePipeline||c.prePipeline,e.postPipeline=b.postPipeline||c.postPipeline,e.partialResolver=b.partialResolver||c.partialResolver,e.values=d.extend({},b.values,c.values),e.partials=d.extend({},b.partials,c.partials),e.templates=d.extend({},b.templates,c.templates),e.processors=d.extend({},b.processors,c.processors);if(typeof e.noSuchValue!="function")throw new Error('The "noSuchValue" option or setting must be a function.');if(typeof e.noSuchPartial!="function")throw new Error('The "noSuchPartial" option or setting must be a function.');if(typeof e.noSuchProcessor!="function")throw new Error('The "noSuchProcessor" option or setting must be a function.');if(typeof e.prePipeline!="function")throw new Error('The "prePipeline" option or setting must be a function.');if(typeof e.postPipeline!="function")throw new Error('The "postPipeline" option or setting must be a function.');return d.prepare(a,e)};c.name="deku",c.version="0.0.6",c.partials={},c.templates={},c.values={},c.processors={},c.prePipeline=function(a,b,c,d,e){return a},c.postPipeline=function(a,b,c,d,e){return a==null?"":a},c.noSuchValue=function(a){throw new Error('The value "'+a+'" is not found.')},c.noSuchPartial=function(a,b){throw new Error('The partial "'+a+'" is not found.')},c.noSuchProcessor=function(a,b,c){throw new Error('The processor "'+a+'" for the value "'+c+'" is not found.')},c.partialResolver=function(a){var b=this,c=b.partials[a];return c==null&&(c=b.templates[a]),c},c.compile=function(a,b){var c,f=typeof a;if(f==="string")c=d.compile(a);else if(f==="function")c=a;else throw new Error('The argument "source" must be a string or a function.');return e(c,b)},c.use=function(a,b){var d=c.templates[a],f=typeof d;if(f==="undefined")throw new Error('The template "'+a+'" is not found.');if(f!=="function")throw new Error('The template "'+a+'" must be a function.');return e(d,b)},a(c)}(function(a){typeof module!="undefined"&&module.exports&&(module.exports=a),typeof define=="function"&&define.amd&&define(a)},function(a){return typeof module!="undefined"&&module.exports?require("./internal/"+a):deku.internal[a]},typeof module!="undefined"&&module.exports?{}:deku);
