/*!
 * jQuery Nano MVC mini framework - v0.3 - 15/03/2012
 * http://www.jqnano.com/
 *
 * Copyright (c) 2012 Oleksii Glib
 * Licensed under the MIT license.
 * http://benalman.com/about/license/
 *
 * Components included with MIT license:
 *  - jQuery HashChange (http://benalman.com/projects/jquery-hashchange-plugin/)
 *  - Simple JavaScript Inheritance (http://ejohn.org/blog/simple-javascript-inheritance/)
 */
(function(a,b,c){function j(a){return a=a||location.href,"#"+a.replace(/^[^#]*#?(.*)$/,"$1")}"$:nomunge";var d="hashchange",e=document,f,g=a.event.special,h=e.documentMode,i="on"+d in b&&(h===c||h>7);a.fn[d]=function(a){return a?this.bind(d,a):this.trigger(d)},a.fn[d].delay=50,g[d]=a.extend(g[d],{setup:function(){if(i)return!1;a(f.start)},teardown:function(){if(i)return!1;a(f.stop)}}),f=function(){function n(){var c=j(),e=m(h);c!==h?(l(h=c,e),a(b).trigger(d)):e!==h&&(location.href=location.href.replace(/#.*/,"")+e),g=setTimeout(n,a.fn[d].delay)}var f={},g,h=j(),k=function(a){return a},l=k,m=k;return f.start=function(){g||n()},f.stop=function(){g&&clearTimeout(g),g=c},a.browser.msie&&!i&&function(){var b,c;f.start=function(){b||(c=a.fn[d].src,c=c&&c+j(),b=a('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){c||l(j()),n()}).attr("src",c||"javascript:0").insertAfter("body")[0].contentWindow,e.onpropertychange=function(){try{event.propertyName==="title"&&(b.document.title=e.title)}catch(a){}})},f.stop=k,m=function(){return j(b.location.href)},l=function(c,f){var g=b.document,h=a.fn[d].domain;c!==f&&(g.title=e.title,g.open(),h&&g.write('<script>document.domain="'+h+'"</script>'),g.close(),b.location.hash=c)}}(),f}()})($,this),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.create=function(c,d){function h(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]=typeof c[g]=="function"&&typeof e[g]=="function"&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];h.prototype=f,h.prototype.constructor=h,h.prototype.create=e.create,h.create=arguments.callee;if(d!=null&&d!=undefined&&d==1)return h;var i=new h;return i.autoRegister(),i}}();var NanoController=Class.create({modulePrefix:null,actions:new Array,autoRegister:function(){jqNanoControllerManager.register(this)},action:function(a,b,c){var d={module:this,name:a,callback:b,options:$.extend({containerSelector:null},c)};this.actions.push(d)},getAction:function(a){var b=this.modulePrefix==null?"":this.modulePrefix+"/";for(var c=0;c<this.actions.length;c++)if(b+this.actions[c].name==a)return this.actions[c];return null},getTemplateFullCode:function(a){return(this.modulePrefix==null?"":this.modulePrefix+"/")+a},template:function(a,b){jqNanoControllerManager.templates.add(this.getTemplateFullCode(a),b)},templateFromUri:function(a,b){var c=b!=null&&b!=undefined?b:a+".tpl";jqNanoControllerManager.templates.addFromUri(this.getTemplateFullCode(a),c)},templateFromElement:function(a,b){var c=b!=null&&b!=undefined?b:a.replace("/","-");jqNanoControllerManager.templates.addFromElement(this.getTemplateFullCode(a),c)},view:function(a,b,c){return{type:"template",options:{code:this.getTemplateFullCode(a),params:b,callback:c}}}},!0),NanoTemplateEngine=Class.create({templates:new Array,compiler:null,init:function(a){this.cm=a},add:function(a,b){var c=this.get(a),d=!1;c==null&&(d=!0,c={code:a}),c.content=b,d&&this.templates.push(c)},addFromUri:function(a,b){var c=this.get(a),d=!1;c==null&&(d=!0,c={code:a}),c.contentUri=b,d&&this.templates.push(c)},addFromElement:function(a,b){var c=this.get(a),d=!1;c==null&&(d=!0,c={code:a}),c.contentId=b,d&&this.templates.push(c)},load:function(a,b,c){var d=this.get(a);if(d==null){b(a,null,c);return}if(d.hasOwnProperty("compiled")&&d.compiled!=null){b(a,d.compiled,c);return}if(!!d.hasOwnProperty("content")){d.compiled=this.compile(d.content),b(a,d.compiled,c);return}if(d.hasOwnProperty("contentUri")){var e=this;this.downloadHtml(d.contentUri,function(f){d.content=f,d.compiled=e.compile(d.content),b(a,d.compiled,c)},function(){b(a,null,c)});return}if(d.hasOwnProperty("contentId")){d.content=$("#"+d.contentId).html(),d.compiled=this.compile(d.content),b(a,d.compiled,c);return}b(a,null,c)},downloadHtml:function(a,b,c){$.ajax({url:a,success:function(a){b(a)},error:function(b,d,e){$.mvcLog("Error downloading template `"+a+"`"),$.mvcLog(e),c()},dataType:"html"})},getCompiler:function(){if(this.compiler==null){var a=this.cm.options.templateCompiler;a==null?this.compiler=function(a){return function(b){return a}}:this.compiler=a}return this.compiler},compile:function(a){return this.getCompiler()(a)},get:function(a){for(var b=0;b<this.templates.length;b++)if(this.templates[b].code==a)return this.templates[b];return null}},!0),jqNanoControllerManager=function(){var a=new Object;return a.modules=new Array,a.options={isDebug:!1,defaultRoute:"default",error404:null,templateCompiler:null},a.lastRun=null,a.initialized=!1,a.templates=new NanoTemplateEngine(a),a.getAction=function(a){for(var b=0;b<this.modules.length;b++){var c=this.modules[b].getAction(a);if(c!=null)return c}return null},a.parseHash=function(a){var b={action:"",params:null};if(a==null||a==undefined||typeof a!="string")return b;var c=a.split("?",2);b.action=c[0];if(c.length==2){c=c[1].split("&");for(var d=0;d<c.length;d++){var e=c[d].split("=",2);if(e.length!=2)continue;b.params==null&&(b.params=new Object),b.params[e[0]]=e[1]}}return b},a.processResult=function(a,b,c){switch(c.type){case"template":var d=c.options.params;this.templates.load(c.options.code,function(e,f){if(f==null)$.mvcLog("No template for "+c.options.code);else{a.html(f(d));var g=c.options.callback;if(g!=null&&g!=undefined)try{typeof g=="string"?b[g]():g()}catch(h){console.log(h)}}});break;default:}},a.run=function(b){b.length==0&&(b=a.options.defaultRoute);if(this.lastRun==b)return;var c=this.parseHash(b),d=this.getAction(c.action);d==null&&this.options.error404!=null&&(c=this.parseHash(this.options.error404),d=this.getAction(c.action));if(d==null)return null;this.lastRun=b,$.mvcLog("Launching "+b);var e=null;try{e=d.callback.apply(d.module,c.params),e!=null&&d.options.containerSelector!=null&&this.processResult($(d.options.containerSelector),d.module,e),b!=a.options.defaultRoute?window.location.hash=b:window.location.hash=""}catch(f){$.mvcLog(f)}return e},a.register=function(a){a instanceof NanoController&&this.modules.push(a)},a.onHashChange=function(){var b=location.hash;b!=null&&b!=undefined&typeof b=="string"&&b.length>2?a.run(b.substr(1)):a.run(a.options.defaultRoute)},a.initialize=function(){if(this.initialized)return;this.initialized=!0,this.bindLive();try{$(window).hashchange(a.onHashChange),$(window).hashchange()}catch(b){a.onHashChange()}},a.bindLive=function(){$("[nano-action]").live("click",function(){var b=$(this).attr("nano-action");return a.run(b),!1}),$("script[nano-template]").each(function(b,c){var c=$(c),d=c.attr("nano-template");a.templates.add(d,c.html())})},a.log=function(b){a.options.isDebug==1&&console.log(b)},a}();$.extend($,{mvcLog:jqNanoControllerManager.log,nanoMvc:function(a){return a!=null&&a!=undefined&&a.prototype instanceof NanoController?(jqNanoControllerManager.register(new a),jqNanoControllerManager):(jqNanoControllerManager.options=$.extend(jqNanoControllerManager.options,a),jqNanoControllerManager.options.base=window.location,this.mvcLog("Mvc Initialized"),jqNanoControllerManager.initialize(),jqNanoControllerManager)}});
